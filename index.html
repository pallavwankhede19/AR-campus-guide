<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Navigation</title>
    <!-- Tailwind CSS for modern UI styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame and AR.js for augmented reality -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- TensorFlow.js for the MobileNetV2 model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    
    <style>
        /* Custom styles for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .arjs-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .arjs-loader > div {
            text-align: center;
            color: white;
            font-size: 1.25rem;
        }
        .controls {
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen relative overflow-hidden">

    <!-- AR Scene setup -->
    <!-- AR.js handles the camera feed and pose estimation -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <!-- Camera that automatically follows the user's movement -->
        <a-marker-camera preset="hiro">
            <!-- This is the 3D arrow that will be overlaid on the environment -->
            <a-box id="guide-arrow" color="blue" opacity="0.8" scale="0.5 0.5 0.5" position="0 0.5 -1" visible="false">
                <a-cone color="blue" opacity="0.8" position="0 0.5 0" rotation="0 0 0" scale="0.8 0.8 0.8"></a-cone>
            </a-box>
        </a-marker-camera>
        <a-entity light="type: ambient; color: #BBB;"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.6;" position="-1 1 1"></a-entity>
    </a-scene>

    <!-- UI Overlay for controls and status messages -->
    <div class="fixed inset-0 flex flex-col items-center justify-between p-4 controls">
        <!-- Top Section: Status and Controls -->
        <div class="w-full max-w-lg bg-white bg-opacity-90 rounded-xl shadow-lg p-4 text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">AR Campus Guide</h1>
            <p id="status-message" class="text-gray-600 mb-4">
                Loading model and map...
            </p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-4">
                <select id="destination-select" class="w-full md:w-auto p-2 border border-gray-300 rounded-lg text-gray-700 bg-white">
                    <option value="" disabled selected>Select Destination</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
                <button id="guide-button" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg shadow-md transition-colors duration-300" disabled>
                    Start Guiding
                </button>
            </div>
            <div id="loading" class="hidden text-center text-blue-500 font-semibold">
                <div class="inline-block h-6 w-6 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status">
                    <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Location Info -->
        <div class="w-full max-w-lg bg-white bg-opacity-90 rounded-xl shadow-lg p-4 text-center">
            <p class="text-gray-600 font-bold">Current Location:</p>
            <p id="current-location" class="text-xl text-gray-800 font-medium">Determining...</p>
        </div>
    </div>

    <!-- JavaScript logic -->
    <script>
        // Set up the scene and UI elements
        const arScene = document.querySelector('a-scene');
        const statusMessage = document.getElementById('status-message');
        const destinationSelect = document.getElementById('destination-select');
        const guideButton = document.getElementById('guide-button');
        const currentLocationText = document.getElementById('current-location');
        const loadingDiv = document.getElementById('loading');
        const guideArrow = document.getElementById('guide-arrow');
        
        let model;
        let mapData;
        let labels;
        let modelLoaded = false;
        let mapLoaded = false;
        let labelsLoaded = false;
        let currentFloor = null;
        let destinationNode = null;
        let path = [];

        // *** CORRECTED: Use your GitHub Pages URL to load the model and labels from the root directory ***
        const GITHUB_PAGES_URL = 'https://pallawankhede19.github.io/AR-campus-guide/';
        const MODEL_URL = GITHUB_PAGES_URL + 'model.json';
        const LABELS_URL = GITHUB_PAGES_URL + 'labels.json';
        const IMAGE_SIZE = 224;
        
        // *** MOCK MAP DATA ***
        // This is a sample map object. You should replace this with the contents of your
        // actual map.json file once it is hosted publicly.
        const mockMapData = {
            "nodes": {
                "floor1-start": { "floor": "1st Floor", "label": "Entrance to 1st Floor" },
                "floor1-mid": { "floor": "1st Floor", "label": "Main Hallway" },
                "floor1-stairs": { "floor": "1st Floor", "label": "Stairs to 2nd Floor" },
                "floor2-start": { "floor": "2nd Floor", "label": "2nd Floor Landing" },
                "floor2-mid": { "floor": "2nd Floor", "label": "Library Entrance" },
                "floor2-end": { "floor": "2nd Floor", "label": "Professor's Office" }
            },
            "connections": {
                "floor1-start": ["floor1-mid"],
                "floor1-mid": ["floor1-start", "floor1-stairs"],
                "floor1-stairs": ["floor1-mid", "floor2-start"],
                "floor2-start": ["floor1-stairs", "floor2-mid"],
                "floor2-mid": ["floor2-start", "floor2-end"],
                "floor2-end": ["floor2-mid"]
            }
        };

        // --- Model and Map Loading ---
        async function loadAssets() {
            loadingDiv.style.display = 'block';
            statusMessage.innerText = 'Loading AI model...';

            // Load the labels
            try {
                const labelsResponse = await fetch(LABELS_URL);
                labels = await labelsResponse.json();
                labelsLoaded = true;
                console.log('Labels loaded successfully!');
            } catch (error) {
                statusMessage.innerText = 'Error loading labels.';
                console.error('Failed to load labels:', error);
                return;
            }

            // Load the model
            try {
                model = await tf.loadGraphModel(MODEL_URL);
                modelLoaded = true;
                console.log('Model loaded successfully!');
            } catch (error) {
                statusMessage.innerText = 'Error loading model.';
                console.error('Failed to load model:', error);
                return;
            }

            // Load the map
            statusMessage.innerText = 'Loading map data...';
            // Use the mock data directly instead of fetching from a URL
            mapData = mockMapData;
            mapLoaded = true;
            console.log('Map loaded successfully from mock data!');

            loadingDiv.style.display = 'none';
            statusMessage.innerText = 'Model and map loaded. Ready to classify.';
            guideButton.disabled = false;
            setupUI();
        }

        // --- UI Setup ---
        // Dynamically populate the destination dropdown from the map data
        function setupUI() {
            destinationSelect.innerHTML = '<option value="" disabled selected>Select Destination</option>';
            const destinations = new Set();
            for (const nodeId in mapData.nodes) {
                destinations.add(mapData.nodes[nodeId].label);
            }
            Array.from(destinations).sort().forEach(label => {
                const option = document.createElement('option');
                option.value = label;
                option.text = label;
                destinationSelect.appendChild(option);
            });
        }
        
        // --- Pathfinding Algorithm (Breadth-First Search) ---
        function findPath(startLabel, endLabel) {
            const startNodeId = Object.keys(mapData.nodes).find(key => mapData.nodes[key].label === startLabel);
            const endNodeId = Object.keys(mapData.nodes).find(key => mapData.nodes[key].label === endLabel);
            
            if (!startNodeId || !endNodeId) {
                return null;
            }

            const queue = [[startNodeId]];
            const visited = new Set([startNodeId]);

            while (queue.length > 0) {
                const currentPath = queue.shift();
                const currentNodeId = currentPath[currentPath.length - 1];

                if (currentNodeId === endNodeId) {
                    return currentPath;
                }

                const connections = mapData.connections[currentNodeId] || [];
                for (const nextNodeId of connections) {
                    if (!visited.has(nextNodeId)) {
                        visited.add(nextNodeId);
                        const newPath = [...currentPath, nextNodeId];
                        queue.push(newPath);
                    }
                }
            }
            return null; // Path not found
        }
        
        // --- Core AR Logic ---
        
        async function classifyEnvironment() {
            if (!modelLoaded) {
                console.error("Model not loaded.");
                return;
            }
            
            statusMessage.innerText = 'Classifying environment...';
            loadingDiv.style.display = 'block';

            const video = document.querySelector('video');
            if (!video) {
                console.error("Video element not found. AR camera not active.");
                loadingDiv.style.display = 'none';
                return;
            }
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const tensor = tf.browser.fromPixels(canvas)
                .resizeBilinear([IMAGE_SIZE, IMAGE_SIZE])
                .toFloat()
                .div(tf.scalar(255))
                .expandDims(0);

            const prediction = await model.predict(tensor);
            const classIndex = tf.argMax(prediction, 1).dataSync()[0];
            currentFloor = labels[classIndex];
            
            tensor.dispose();
            prediction.dispose();

            // Find a corresponding node for the current floor in the mock map
            const currentFloorNode = Object.keys(mapData.nodes).find(key => mapData.nodes[key].floor === currentFloor);
            
            // This is a simplified way to set the current node for pathfinding
            currentLocationText.innerText = `${currentFloor} (Node: ${currentFloorNode})`;
            statusMessage.innerText = `You are on the ${currentFloor}. Now select a destination.`;
            loadingDiv.style.display = 'none';
        }

        function updateGuidanceArrow() {
            if (path.length <= 1) {
                guideArrow.setAttribute('visible', 'false');
                statusMessage.innerText = `You have reached your destination: ${destinationSelect.value}.`;
                return;
            }

            const nextNodeId = path[1];
            const nextNode = mapData.nodes[nextNodeId];
            const currentNode = mapData.nodes[path[0]];

            if (nextNode.floor !== currentNode.floor) {
                // Change floors
                if (parseInt(nextNode.floor) > parseInt(currentNode.floor)) {
                    // Go up
                    statusMessage.innerText = `Find the stairs/elevator. Go up to the ${nextNode.floor}.`;
                    guideArrow.setAttribute('visible', 'true');
                    guideArrow.setAttribute('rotation', '-90 0 0'); // Point up
                } else {
                    // Go down
                    statusMessage.innerText = `Find the stairs/elevator. Go down to the ${nextNode.floor}.`;
                    guideArrow.setAttribute('visible', 'true');
                    guideArrow.setAttribute('rotation', '90 0 0'); // Point down
                }
            } else {
                // Same floor, point forward
                statusMessage.innerText = `Move forward towards ${nextNode.label}.`;
                guideArrow.setAttribute('visible', 'true');
                guideArrow.setAttribute('rotation', '0 0 0');
            }
            
            // Advance the path for the next step (simplified for prototype)
            path.shift();
        }
        
        // --- Event Listeners ---
        guideButton.addEventListener('click', () => {
            const selectedDestination = destinationSelect.value;
            if (!currentFloor || selectedDestination === "") {
                statusMessage.innerText = 'Please classify your location and select a destination first.';
                return;
            }
            
            destinationNode = selectedDestination;
            const startNodeLabel = currentLocationText.innerText.split(' (Node: ')[1]?.replace(')', '');
            
            path = findPath(startNodeLabel, destinationNode);
            
            if (path && path.length > 0) {
                statusMessage.innerText = `Path found. Guiding to ${destinationNode}.`;
                updateGuidanceArrow();
            } else {
                statusMessage.innerText = `Could not find a path to ${destinationNode}.`;
                guideArrow.setAttribute('visible', 'false');
            }
        });

        // The classification logic is now more complex, but we'll trigger it here for the prototype
        destinationSelect.addEventListener('change', classifyEnvironment);

        // Initial setup on page load
        window.onload = loadAssets;

    </script>
</body>
</html>
