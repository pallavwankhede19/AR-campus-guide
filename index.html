<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR Campus Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .controls { z-index: 1000; }
  </style>
</head>
<body class="min-h-screen relative overflow-hidden">

  <!-- AR Scene -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-marker-camera preset="hiro">
      <a-box id="guide-arrow" color="blue" opacity="0.8" scale="0.5 0.5 0.5" position="0 0.5 -1" visible="false">
        <a-cone color="blue" opacity="0.8" position="0 0.5 0" scale="0.8 0.8 0.8"></a-cone>
      </a-box>
    </a-marker-camera>
    <a-entity light="type: ambient; color: #BBB;"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.6;" position="-1 1 1"></a-entity>
  </a-scene>

  <!-- UI Overlay -->
  <div class="fixed inset-0 flex flex-col items-center justify-between p-4 controls">
    <div class="w-full max-w-lg bg-white bg-opacity-90 rounded-xl shadow-lg p-4 text-center">
      <h1 class="text-2xl font-bold text-gray-800 mb-2">AR Campus Guide</h1>
      <p id="status-message" class="text-gray-600 mb-4">Loading model and map...</p>
      <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-4">
        <select id="destination-select" class="w-full md:w-auto p-2 border border-gray-300 rounded-lg text-gray-700 bg-white">
          <option value="" disabled selected>Select Destination</option>
        </select>
        <button id="guide-button" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg shadow-md transition-colors duration-300" disabled>
          Start Guiding
        </button>
      </div>
      <div id="loading" class="hidden text-center text-blue-500 font-semibold">
        <div class="inline-block h-6 w-6 animate-spin rounded-full border-4 border-solid border-current border-r-transparent"></div>
      </div>
    </div>

    <div class="w-full max-w-lg bg-white bg-opacity-90 rounded-xl shadow-lg p-4 text-center">
      <p class="text-gray-600 font-bold">Current Location:</p>
      <p id="current-location" class="text-xl text-gray-800 font-medium">Determining...</p>
    </div>
  </div>

  <script>
    const statusMessage = document.getElementById("status-message");
    const destinationSelect = document.getElementById("destination-select");
    const guideButton = document.getElementById("guide-button");
    const currentLocationText = document.getElementById("current-location");
    const loadingDiv = document.getElementById("loading");
    const guideArrow = document.getElementById("guide-arrow");

    let model, labels, mapData;
    let path = [];

    const BASE_URL = "https://pallawankhede19.github.io/AR-campus-guide/";
    const MODEL_URL = BASE_URL + "model.json";
    const LABELS_URL = BASE_URL + "labels.json";
    const MAP_URL = BASE_URL + "map.json";
    const IMAGE_SIZE = 224;

    async function loadAssets() {
      loadingDiv.style.display = "block";

      try {
        const labelsResponse = await fetch(LABELS_URL);
        labels = await labelsResponse.json();
        console.log("Labels loaded:", labels);
      } catch (err) {
        statusMessage.innerText = "Error loading labels.";
        console.error(err);
        return;
      }

      try {
        model = await tf.loadGraphModel(MODEL_URL);
        console.log("Model loaded!");
      } catch (err) {
        statusMessage.innerText = "Error loading model.";
        console.error(err);
        return;
      }

      try {
        const mapResponse = await fetch(MAP_URL);
        mapData = await mapResponse.json();
        console.log("Map loaded:", mapData);
      } catch (err) {
        statusMessage.innerText = "Error loading map.";
        console.error(err);
        return;
      }

      loadingDiv.style.display = "none";
      statusMessage.innerText = "Model, labels, and map loaded!";
      guideButton.disabled = false;

      setupUI();
    }

    function setupUI() {
      destinationSelect.innerHTML = '<option value="" disabled selected>Select Destination</option>';
      for (const nodeId in mapData.nodes) {
        const option = document.createElement("option");
        option.value = nodeId;
        option.text = mapData.nodes[nodeId].label;
        destinationSelect.appendChild(option);
      }
    }

    function findPath(start, end) {
      const queue = [[start]];
      const visited = new Set([start]);
      while (queue.length) {
        const path = queue.shift();
        const node = path[path.length - 1];
        if (node === end) return path;
        for (const next of mapData.connections[node] || []) {
          if (!visited.has(next)) {
            visited.add(next);
            queue.push([...path, next]);
          }
        }
      }
      return null;
    }

    async function classifyEnvironment() {
      const video = document.querySelector("video");
      if (!video) return;

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      const tensor = tf.browser.fromPixels(canvas)
        .resizeBilinear([IMAGE_SIZE, IMAGE_SIZE])
        .toFloat().div(255).expandDims(0);

      const prediction = await model.predict(tensor);
      const classIndex = prediction.argMax(1).dataSync()[0];
      const currentLabel = labels[classIndex];

      tensor.dispose();
      prediction.dispose();

      currentLocationText.innerText = currentLabel;
      statusMessage.innerText = "Detected: " + currentLabel;
      return currentLabel;
    }

    function updateGuidance(path) {
      if (!path || path.length <= 1) {
        guideArrow.setAttribute("visible", "false");
        statusMessage.innerText = "Destination reached!";
        return;
      }
      guideArrow.setAttribute("visible", "true");
      guideArrow.setAttribute("rotation", "0 0 0");
      statusMessage.innerText = "Move towards " + mapData.nodes[path[1]].label;
    }

    guideButton.addEventListener("click", async () => {
      const currentLabel = await classifyEnvironment();
      if (!currentLabel) return;

      const start = Object.keys(mapData.nodes).find(k => mapData.nodes[k].label === currentLabel);
      const end = destinationSelect.value;

      path = findPath(start, end);
      if (path) updateGuidance(path);
      else statusMessage.innerText = "Path not found!";
    });

    window.onload = loadAssets;
  </script>
</body>
</html>
